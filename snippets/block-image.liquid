{% comment %}
  Block Image Renderer - Renders image blocks from the universal container
{% endcomment %}

{% liquid
  assign image = block.settings.image
  assign image_size = block.settings.image_size | default: 'medium'
  assign aspect_ratio = block.settings.aspect_ratio | default: 'auto'
  assign image_fit = block.settings.image_fit | default: 'cover'
  assign image_alignment = block.settings.image_alignment | default: 'center'
  assign border_radius = block.settings.border_radius | default: '0'
  assign overlay_color = block.settings.overlay_color
  assign overlay_opacity = block.settings.overlay_opacity | default: 0
  assign blend_mode = block.settings.blend_mode | default: 'normal'
  assign animation_type = block.settings.animation_type | default: 'none'
  assign lazy_load = block.settings.lazy_load | default: true
  
  assign sizes = '(max-width: 768px) 100vw, 50vw'
  case image_size
    when 'small'
      assign sizes = '(max-width: 768px) 50vw, 25vw'
    when 'medium'
      assign sizes = '(max-width: 768px) 100vw, 50vw'
    when 'large'
      assign sizes = '(max-width: 768px) 100vw, 75vw'
    when 'full'
      assign sizes = '100vw'
  endcase
%}

<div class="block-image" 
     data-block-id="{{ block.id }}"
     data-image-size="{{ image_size }}"
     data-aspect-ratio="{{ aspect_ratio }}"
     data-animation="{{ animation_type }}"
     style="
       text-align: {{ image_alignment }};
       border-radius: {{ border_radius }};
     ">
  
  {% if image != blank %}
    <div class="image-container" 
         style="
           {% if aspect_ratio != 'auto' %}
             aspect-ratio: {{ aspect_ratio }};
           {% endif %}
           border-radius: {{ border_radius }};
           overflow: hidden;
           position: relative;
         ">
      
      {% comment %} Main Image {% endcomment %}
      <img 
        src="{{ image | image_url: width: 800 }}"
        srcset="{{ image | image_url: width: 400 }} 400w,
                {{ image | image_url: width: 800 }} 800w,
                {{ image | image_url: width: 1200 }} 1200w,
                {{ image | image_url: width: 1600 }} 1600w"
        sizes="{{ sizes }}"
        alt="{{ block.settings.alt_text | default: image.alt | escape }}"
        class="block-image-element"
        width="{{ image.width }}"
        height="{{ image.height }}"
        style="
          width: 100%;
          height: 100%;
          object-fit: {{ image_fit }};
          mix-blend-mode: {{ blend_mode }};
        "
        {% if lazy_load %}loading="lazy"{% endif %}
      >
      
      {% comment %} Overlay {% endcomment %}
      {% if overlay_color != blank and overlay_opacity > 0 %}
        <div class="image-overlay"
             style="
               position: absolute;
               top: 0;
               left: 0;
               width: 100%;
               height: 100%;
               background-color: {{ overlay_color }};
               opacity: {{ overlay_opacity | divided_by: 100.0 }};
               pointer-events: none;
             "></div>
      {% endif %}
      
      {% comment %} Caption {% endcomment %}
      {% if block.settings.caption != blank %}
        <div class="image-caption" 
             style="
               position: absolute;
               bottom: 0;
               left: 0;
               right: 0;
               background: linear-gradient(transparent, rgba(0,0,0,0.7));
               color: white;
               padding: 1rem;
               font-size: 0.875rem;
             ">
          {{ block.settings.caption | escape }}
        </div>
      {% endif %}
    </div>
    
    {% comment %} External Caption {% endcomment %}
    {% if block.settings.external_caption != blank %}
      <div class="image-external-caption" 
           style="
             margin-top: 0.5rem;
             font-size: 0.875rem;
             color: var(--color-base-text-secondary);
             text-align: {{ image_alignment }};
           ">
        {{ block.settings.external_caption }}
      </div>
    {% endif %}
    
  {% else %}
    {% if request.design_mode %}
      <div class="block-placeholder" 
           style="
             min-height: 200px;
             background: var(--color-base-border);
             border: 2px dashed var(--color-base-text-secondary);
             border-radius: {{ border_radius }};
             display: flex;
             align-items: center;
             justify-content: center;
             color: var(--color-base-text-secondary);
           ">
        <div style="text-align: center;">
          <p>üñºÔ∏è Add an image</p>
          <small>Click to select an image from your media library</small>
        </div>
      </div>
    {% endif %}
  {% endif %}
</div>