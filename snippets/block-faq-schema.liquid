{% comment %}
  FAQ Schema Block Snippet Renderer
  File: snippets/block-faq-schema.liquid
{% endcomment %}

{% liquid
  assign block_id = 'faq-block-' | append: block.id
  assign accordion_style = block.settings.accordion_style | default: 'modern'
  assign show_icons = block.settings.show_icons | default: true
  assign open_first = block.settings.open_first | default: false
  assign allow_multiple = block.settings.allow_multiple | default: false
  assign animation_speed = block.settings.animation_speed | default: 'normal'
  
  comment 'FAQ Data Collection'
  assign faq_items = ''
  assign faq_count = 0
  
  for i in (1..20)
    assign question_setting = 'faq_question_' | append: i
    assign answer_setting = 'faq_answer_' | append: i
    assign question = block.settings[question_setting]
    assign answer = block.settings[answer_setting]
    
    if question != blank and answer != blank
      assign faq_count = faq_count | plus: 1
      assign faq_item = question | append: '|||' | append: answer
      if faq_items == blank
        assign faq_items = faq_item
      else
        assign faq_items = faq_items | append: '^^^' | append: faq_item
      endif
    endif
  endfor
  
  comment 'Split FAQ items for processing'
  assign faq_list = faq_items | split: '^^^'
%}

{% comment %} FAQ Block Container {% endcomment %}
<div class="faq-schema-block {{ accordion_style }}" id="{{ block_id }}" {{ block.shopify_attributes }}>
  
  {% comment %} Block Header {% endcomment %}
  {% if block.settings.block_title != blank or block.settings.block_description != blank %}
    <div class="faq-header">
      {% if block.settings.block_title != blank %}
        <h2 class="faq-title tx-heading-2">{{ block.settings.block_title }}</h2>
      {% endif %}
      {% if block.settings.block_description != blank %}
        <p class="faq-description tx-body">{{ block.settings.block_description }}</p>
      {% endif %}
    </div>
  {% endif %}
  
  {% comment %} FAQ Accordion {% endcomment %}
  {% if faq_count > 0 %}
    <div class="faq-accordion" 
         data-allow-multiple="{{ allow_multiple }}"
         data-animation-speed="{{ animation_speed }}">
      
      {% for faq_item in faq_list %}
        {% assign faq_parts = faq_item | split: '|||' %}
        {% assign question = faq_parts[0] %}
        {% assign answer = faq_parts[1] %}
        {% assign item_index = forloop.index %}
        {% assign item_id = block_id | append: '-item-' | append: item_index %}
        {% if open_first and forloop.first %}
          {% assign is_first_open = true %}
        {% else %}
          {% assign is_first_open = false %}
        {% endif %}
        
        <div class="faq-item" data-faq-item="{{ item_index }}">
          
          {% comment %} Question Button {% endcomment %}
          <button class="faq-question" 
                  type="button"
                  aria-expanded="{{ is_first_open }}"
                  aria-controls="{{ item_id }}-answer"
                  id="{{ item_id }}-question"
                  data-faq-toggle="{{ item_index }}">
            
            <span class="faq-question-text tx-heading-4">{{ question }}</span>
            
            {% if show_icons %}
              <span class="faq-icon" aria-hidden="true">
                <svg class="faq-icon-plus" width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <svg class="faq-icon-minus" width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
            {% endif %}
          </button>
          
          {% comment %} Answer Content {% endcomment %}
          <div class="faq-answer" 
               id="{{ item_id }}-answer"
               aria-labelledby="{{ item_id }}-question"
               data-faq-content="{{ item_index }}"
               {% unless is_first_open %}hidden{% endunless %}>
            <div class="faq-answer-content tx-body">
              {{ answer | newline_to_br }}
            </div>
          </div>
          
        </div>
      {% endfor %}
      
    </div>
  {% else %}
    {% comment %} Empty State (Design Mode) {% endcomment %}
    {% if request.design_mode %}
      <div class="faq-empty-state">
        <div class="empty-state-content">
          <h3 class="tx-heading-3">ðŸ™‹ FAQ Block</h3>
          <p class="tx-body">Add your first FAQ question and answer in the block settings to get started.</p>
          <p class="tx-body-small">This block automatically generates SEO-optimized schema markup for search engines.</p>
        </div>
      </div>
    {% endif %}
  {% endif %}
  
</div>

{% comment %} Auto-Generated FAQ Schema {% endcomment %}
{% if faq_count > 0 %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    {% if block.settings.block_title != blank %}
    "name": {{ block.settings.block_title | json }},
    {% endif %}
    {% if block.settings.block_description != blank %}
    "description": {{ block.settings.block_description | json }},
    {% endif %}
    "mainEntity": [
      {% for faq_item in faq_list %}
        {% assign faq_parts = faq_item | split: '|||' %}
        {% assign question = faq_parts[0] %}
        {% assign answer = faq_parts[1] %}
        {
          "@type": "Question",
          "name": {{ question | json }},
          "acceptedAnswer": {
            "@type": "Answer",
            "text": {{ answer | strip_html | json }}
          }
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  }
  </script>
{% endif %}