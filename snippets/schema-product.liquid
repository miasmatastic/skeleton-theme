{% comment %}
  Product Schema Generator
  Generates rich product structured data for better search results
  
  Usage: {% render 'schema-product' %}
{% endcomment %}

{% render 'schema-config' %}

<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Product",
  "@id": "{{ product.url | prepend: shop.secure_url }}#product",
  "name": "{{ product.title | escape }}",
  "description": "{{ product.description | strip_html | truncate: 300 | escape }}",
  "category": "{{ product.type | escape }}",
  "brand": {
    "@type": "Brand",
    "name": "{{ product.vendor | default: schema_business_name | escape }}"
  },
  "manufacturer": {
    "@type": "Organization",
    "name": "{{ product.vendor | default: schema_business_name | escape }}"
  },
  "image": [
    {% for image in product.images limit: 5 %}
      "{{ image | image_url: width: 1200 }}"{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ],
  "url": "{{ product.url | prepend: shop.secure_url }}",
  "sku": "{{ product.selected_or_first_available_variant.sku | escape }}",
  "mpn": "{{ product.selected_or_first_available_variant.barcode | escape }}",
  "gtin": "{{ product.selected_or_first_available_variant.barcode | escape }}",
  {% if product.available %}
  "offers": {
    "@type": "Offer",
    "url": "{{ product.url | prepend: shop.secure_url }}",
    "priceCurrency": "{{ cart.currency.iso_code }}",
    "price": "{{ product.price | money_without_currency | remove: ',' }}",
    "priceValidUntil": "{{ 'now' | date: '%s' | plus: 31536000 | date: '%Y-%m-%d' }}",
    "availability": "{% if product.available %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}",
    "itemCondition": "https://schema.org/NewCondition",
    "seller": {
      "@type": "Organization",
      "name": "{{ schema_business_name | escape }}",
      "url": "{{ shop.secure_url }}"
    },
    "shippingDetails": {
      "@type": "OfferShippingDetails",
      "shippingRate": {
        "@type": "MonetaryAmount",
        "value": "0.00",
        "currency": "{{ cart.currency.iso_code }}"
      },
      "deliveryTime": {
        "@type": "ShippingDeliveryTime",
        "handlingTime": {
          "@type": "QuantitativeValue",
          "minValue": 1,
          "maxValue": 3,
          "unitCode": "DAY"
        },
        "transitTime": {
          "@type": "QuantitativeValue", 
          "minValue": 3,
          "maxValue": 7,
          "unitCode": "DAY"
        }
      }
    }
  },
  {% endif %}
  {% if product.variants.size > 1 %}
  "model": [
    {% for variant in product.variants %}
    {
      "@type": "ProductModel",
      "name": "{{ variant.title | escape }}",
      "sku": "{{ variant.sku | escape }}",
      "offers": {
        "@type": "Offer",
        "price": "{{ variant.price | money_without_currency | remove: ',' }}",
        "priceCurrency": "{{ cart.currency.iso_code }}",
        "availability": "{% if variant.available %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}"
      }
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ],
  {% endif %}
  {% comment %} Add review aggregate if you have a review app {% endcomment %}
  {% if product.metafields.reviews.rating != blank %}
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ product.metafields.reviews.rating }}",
    "reviewCount": "{{ product.metafields.reviews.count | default: 1 }}",
    "bestRating": "5",
    "worstRating": "1"
  },
  {% endif %}
  "additionalProperty": [
    {% for tag in product.tags %}
    {
      "@type": "PropertyValue",
      "name": "tag",
      "value": "{{ tag | escape }}"
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ],
  "isRelatedTo": [
    {% for related_product in collections[product.type].products limit: 3 %}
      {% unless related_product.id == product.id %}
      {
        "@type": "Product",
        "name": "{{ related_product.title | escape }}",
        "url": "{{ related_product.url | prepend: shop.secure_url }}"
      }{% unless forloop.last %},{% endunless %}
      {% endunless %}
    {% endfor %}
  ]
}
</script>